# Ticketing API stack: Postgres, Redis (cache + queues), Kafka, Jaeger, API, Traefik (reverse proxy + HTTPS).
# For load-balanced API: docker compose up -d --scale api=2
# HTTPS uses self-signed certs in ./certs (generate with: make certs or see README).

services:
    postgres:
        image: postgres:16
        container_name: ticketing-postgres
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: ticketing
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']

    redis:
        image: redis:7-alpine
        container_name: ticketing-redis
        command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
        ports:
            - '6379:6379'
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']

    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: ticketing-zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - '2181:2181'
        healthcheck:
            test: ['CMD-SHELL', 'nc -z localhost 2181 || exit 1']
            interval: 10s
            timeout: 5s
            retries: 5

    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: ticketing-kafka
        depends_on:
            zookeeper:
                condition: service_healthy
        ports:
            - '9092:9092'
            - '9093:29092'
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
            KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1',
                ]
            interval: 10s
            timeout: 10s
            retries: 5
            start_period: 15s

    # Creates required topics and exits; API starts after this completes (with ~3s delay for Kafka to be ready).
    kafka-init:
        image: confluentinc/cp-kafka:7.5.0
        container_name: ticketing-kafka-init
        depends_on:
            kafka:
                condition: service_healthy
        restart: 'no'
        command: >
            bash -c "
            sleep 3 &&
            kafka-topics --create --bootstrap-server kafka:29092 --topic payment.succeeded --partitions 1 --replication-factor 1 --if-not-exists &&
            kafka-topics --create --bootstrap-server kafka:29092 --topic payment.succeeded.dlq --partitions 1 --replication-factor 1 --if-not-exists
            "

    # Prometheus scrapes Jaeger's spanmetrics endpoint (8889) for the Monitor tab. Must start before Jaeger.
    prometheus:
        image: prom/prometheus:v3.2.0
        container_name: ticketing-prometheus
        volumes:
            - ./monitor/prometheus.yml:/etc/prometheus/prometheus.yml:ro
        ports:
            - '9090:9090'
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.enable-lifecycle'

    # Jaeger v2 with SPM (Monitor tab): spanmetrics connector + Prometheus for RED metrics.
    jaeger:
        image: jaegertracing/jaeger:2.15.1
        container_name: ticketing-jaeger
        command: ['--config', '/etc/jaeger/config.yml']
        volumes:
            - ./monitor/jaeger-config-spm.yaml:/etc/jaeger/config.yml:ro
            - ./monitor/jaeger-ui.json:/etc/jaeger/jaeger-ui.json:ro
        ports:
            - '16686:16686'
            - '4317:4317'
            - '4318:4318'
            - '8888:8888'
            - '8889:8889'
        depends_on:
            prometheus:
                condition: service_started

    api:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            NODE_ENV: development
            DATABASE_URL: postgresql://postgres:postgres@postgres:5432/ticketing
            REDIS_URL: redis://redis:6379
            KAFKA_BROKERS: kafka:29092
            JWT_SECRET: your-256-bit-secret-key-here-change-in-production-minimum-32-characters
            FRONTEND_URL: https://localhost
            STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_fake}
            STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_fake}
            LOG_LEVEL: info
            OTEL_SERVICE_NAME: ticketing-api
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_TRACES_EXPORTER: otlp
            OTEL_METRICS_EXPORTER: otlp
            EVENTS_CACHE_TTL_SECONDS: 60
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            kafka-init:
                condition: service_completed_successfully
            jaeger:
                condition: service_started
        ports:
            - '3001:3001'
        labels:
            - traefik.enable=true
            - traefik.http.routers.api-https.rule=PathPrefix(`/`)
            - traefik.http.routers.api-https.entrypoints=websecure
            - traefik.http.routers.api-https.tls=true
            - traefik.http.routers.api-https.service=api
            - traefik.http.routers.api-http.rule=PathPrefix(`/`)
            - traefik.http.routers.api-http.entrypoints=web
            - traefik.http.routers.api-http.service=api
            - traefik.http.routers.api-http.middlewares=redirect-to-https
            - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
            - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true
            - traefik.http.services.api.loadbalancer.server.port=3001
        networks:
            - default

    traefik:
        image: traefik:v3.2
        container_name: ticketing-traefik
        command: --configFile=/etc/traefik/traefik.yml
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./traefik.yml:/etc/traefik/traefik.yml:ro
            - ./traefik-dynamic.yml:/etc/traefik/dynamic.yml:ro
            - ./certs:/certs:ro
        networks:
            - default

volumes:
    postgres_data:
